<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TOTP Generator (No deps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f7f7f8; --fg:#0f172a; --muted:#64748b; --accent:#2563eb; }
    * { box-sizing: border-box; }
    body {
      margin: 0; height: 100vh; display: grid; place-items: center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--fg); background: var(--bg);
    }
    .card {
      width: 360px; max-width: 94vw; background: #fff; border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,.08); padding: 20px;
    }
    h2 { margin: 0 0 12px; font-weight: 700; font-size: 18px; }
    .row { display: flex; gap: 8px; }
    input {
      flex: 1; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 10px;
      font-size: 14px; outline: none;
    }
    input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,.15); }
    button {
      padding: 10px 14px; border: 0; border-radius: 10px; background: var(--accent);
      color: #fff; font-weight: 600; cursor: pointer;
    }
    .muted { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .result {
      display: grid; grid-template-columns: 1fr 56px; align-items: center;
      gap: 12px; margin-top: 16px;
    }
    .code {
      font-size: 32px; letter-spacing: .08em; font-weight: 700;
      padding: 8px 0; min-height: 48px;
    }
    .error { color: #b91c1c; font-size: 13px; min-height: 18px; }
    .ring {
      width: 56px; height: 56px; border-radius: 50%; border: 3px solid #e2e8f0;
      position: relative; display: grid; place-items: center; font-weight: 700;
    }
    .ring::before {
      content: ""; position: absolute; inset: -3px; border-radius: 50%;
      border: 3px solid transparent; border-top-color: var(--accent);
      transform: rotate(var(--rot,0deg)); transition: transform .2s linear;
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>TOTP Generator</h2>
    <div class="row">
      <input id="secret" placeholder="Base32 secret (e.g. JBSWY3DPEHPK3PXP)" />
      <button id="btn">Generate</button>
    </div>
    <div class="muted">Base32 only (letters A–Z and 2–7). Spaces and “=” padding are OK.</div>

    <div class="result">
      <div>
        <div id="code" class="code"></div>
        <div id="err" class="error"></div>
      </div>
      <div class="ring" id="ring"><span id="t"></span></div>
    </div>
  </div>

  <script>
    // --- Base32 (RFC 4648) decode: accepts no/partial padding, spaces, mixed case ---
    const B32 = (() => {
      const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";
      const map = Object.create(null);
      for (let i=0;i<alphabet.length;i++) map[alphabet[i]] = i;
      function clean(s) { return s.toUpperCase().replace(/[\s=]/g, ""); }
      function decode(s) {
        s = clean(s);
        if (!s || /[^A-Z2-7]/.test(s)) throw new Error("Secret must be Base32 (A–Z, 2–7).");
        let bits = 0, value = 0, out = [];
        for (let i=0;i<s.length;i++) {
          value = (value << 5) | map[s[i]];
          bits += 5;
          if (bits >= 8) {
            out.push((value >>> (bits - 8)) & 0xff);
            bits -= 8;
          }
        }
        return new Uint8Array(out);
      }
      return { decode };
    })();

    // --- HMAC-SHA1 using Web Crypto ---
    async function hmacSha1(keyBytes, msgBytes) {
      const key = await crypto.subtle.importKey("raw", keyBytes, { name:"HMAC", hash:"SHA-1" }, false, ["sign"]);
      const sig = await crypto.subtle.sign("HMAC", key, msgBytes);
      return new Uint8Array(sig);
    }

    // --- HOTP/TOTP per RFC 4226/6238 ---
    async function totpNow(secretB32, digits=6, period=30) {
      const key = B32.decode(secretB32);
      const counter = Math.floor(Date.now()/1000/period);
      const msg = new Uint8Array(8);
      for (let i=7;i>=0;i--) { msg[i] = counter & 0xff; counter >>>= 8; } // big-endian
      const hmac = await hmacSha1(key, msg);
      const offset = hmac[hmac.length - 1] & 0x0f;
      const bin = ((hmac[offset] & 0x7f) << 24) |
                  ((hmac[offset+1] & 0xff) << 16) |
                  ((hmac[offset+2] & 0xff) << 8) |
                  (hmac[offset+3] & 0xff);
      const mod = 10 ** digits;
      return String(bin % mod).padStart(digits, "0");
    }

    // UI wiring
    const input = document.getElementById("secret");
    const btn = document.getElementById("btn");
    const codeEl = document.getElementById("code");
    const errEl = document.getElementById("err");
    const ring = document.getElementById("ring");
    const tEl = document.getElementById("t");
    let timer;

    function updateCountdown(period=30) {
      const now = Date.now()/1000;
      const remain = period - (Math.floor(now) % period);
      tEl.textContent = remain;
      const rot = ((period - remain) / period) * 360;
      ring.style.setProperty("--rot", rot + "deg");
    }

    async function render() {
      errEl.textContent = "";
      codeEl.textContent = "";
      try {
        const s = input.value.trim();
        if (!s) { errEl.textContent = "Enter a Base32 secret."; return; }
        const code = await totpNow(s);
        codeEl.textContent = code;
      } catch (e) {
        errEl.textContent = e.message || "Invalid secret";
      }
      updateCountdown();
    }

    btn.addEventListener("click", () => {
      clearInterval(timer);
      render();
      timer = setInterval(render, 1000);
    });

    // Prefill a known-good demo secret (Google example)
    input.value = "JBSWY3DPEHPK3PXP";
    render();
    timer = setInterval(render, 1000);
  </script>
</body>
</html>
